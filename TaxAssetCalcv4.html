<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capital Gains Tax Calculator</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- D3.js for charting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen py-8">
    <div id="root"></div>

    <!-- React and ReactDOM CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>


    <script type="text/babel">
        // Helper to format currency (no cents for input fields)
        const formatCurrencyInput = (amount) => {
            if (amount === '' || amount === null || isNaN(amount)) return '';
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        };

        // Helper to format currency with cents for display
        const formatCurrencyWithCents = (amount) => {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        };

        // Helper to format currency as integer for display (for pie chart and allocations)
        const formatCurrencyInteger = (amount) => {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(Math.round(amount)); // Round to nearest integer for display
        };

        // Helper to format percentage
        const formatPercentage = (rate) => {
            return new Intl.NumberFormat('en-US', {
                style: 'percent',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(rate);
        };

        // Event handlers for formatted number input fields
        const handleInputChangeFormatted = (e, setRawState, setFormattedState) => {
            const value = e.target.value;
            // Remove non-numeric characters for raw value storage
            const rawValue = parseFloat(value.replace(/[^0-9.]/g, '')) || 0;
            setRawState(rawValue);
            setFormattedState(value); // Keep input as typed until blur
        };

        const handleInputBlurFormatted = (setFormattedState, rawValue) => {
            // Format the value on blur
            setFormattedState(formatCurrencyInput(rawValue));
        };

        const handleInputFocusFormatted = (setFormattedState, rawValue) => {
            // Remove formatting on focus to allow easy editing
            setFormattedState(rawValue === 0 ? '' : rawValue.toString());
        };


        // --- Capital Gains Tax Calculator Component ---
        const CapitalGainsTaxCalculator = () => {
            // State variables for user inputs
            const [taxYear, setTaxYear] = React.useState('2024');
            const [filingStatus, setFilingStatus] = React.useState('single');
            const [ordinaryIncome, setOrdinaryIncome] = React.useState('');
            const [shortTermGains, setShortTermGains] = React.useState('');
            const [longTermGains, setLongTermGains] = React.useState('');
            const [itemizedDeductions, setItemizedDeductions] = React.useState('');
            const [errorMessage, setErrorMessage] = React.useState('');

            // State variables for results
            const [federalOrdinaryTax, setFederalOrdinaryTax] = React.useState(0);
            const [federalLTCGTax, setFederalLTCGTax] = React.useState(0);
            const [netInvestmentIncomeTax, setNetInvestmentIncomeTax] = React.useState(0);
            const [waCapitalGainsTax, setWaCapitalGainsTax] = React.useState(0);
            const [totalTax, setTotalTax] = React.useState(0);
            const [showResults, setShowResults] = React.useState(false);

            // New states for detailed breakdown (Federal Ordinary)
            const [federalOrdinaryBreakdown, setFederalOrdinaryBreakdown] = React.useState([]);
            const [federalOrdinaryMarginalRate, setFederalOrdinaryMarginalRate] = React.useState(0);
            const [federalOrdinaryEffectiveRate, setFederalOrdinaryEffectiveRate] = React.useState(0);

            // New states for detailed breakdown (Federal LTCG)
            const [federalLTCGBreakdown, setFederalLTCGBreakdown] = React.useState([]);
            const [federalLTCGMarginalRate, setFederalLTCGMarginalRate] = React.useState(0);
            const [federalLTCGEffectiveRate, setFederalLTCGEffectiveRate] = React.useState(0);

            // Internal states to hold raw numbers for calculation, and formatted strings for display
            const [rawOrdinaryIncome, setRawOrdinaryIncome] = React.useState(0);
            const [rawShortTermGains, setRawShortTermGains] = React.useState(0);
            const [rawLongTermGains, setRawLongTermGains] = React.useState(0);
            const [rawItemizedDeductions, setRawItemizedDeductions] = React.useState(0);

            // State for LLM features
            const [taxTips, setTaxTips] = React.useState('');
            const [capitalGainsExplanation, setCapitalGainsExplanation] = React.useState('');
            const [isLoadingTips, setIsLoadingTips] = React.useState(false);
            const [isLoadingExplanation, setIsLoadingExplanation] = React.useState(false);


            // --- Tax Data Definitions ---
            const FEDERAL_INCOME_BRACKETS = {
                '2024': {
                    'single': [
                        { rate: 0.10, min: 0, max: 11600 },
                        { rate: 0.12, min: 11601, max: 47150 },
                        { rate: 0.22, min: 47151, max: 100525 },
                        { rate: 0.24, min: 100526, max: 191950 },
                        { rate: 0.32, min: 191951, max: 243725 },
                        { rate: 0.35, min: 243726, max: 609350 },
                        { rate: 0.37, min: 609351, max: Infinity }
                    ],
                    'married': [
                        { rate: 0.10, min: 0, max: 23200 },
                        { rate: 0.12, min: 23201, max: 94300 },
                        { rate: 0.22, min: 94301, max: 201050 },
                        { rate: 0.24, min: 201051, max: 383900 },
                        { rate: 0.32, min: 383901, max: 487450 },
                        { rate: 0.35, min: 487451, max: 731200 },
                        { rate: 0.37, min: 731201, max: Infinity }
                    ]
                },
                '2025': {
                    'single': [
                        { rate: 0.10, min: 0, max: 11925 },
                        { rate: 0.12, min: 11926, max: 48475 },
                        { rate: 0.22, min: 48476, max: 103350 },
                        { rate: 0.24, min: 103351, max: 197300 },
                        { rate: 0.32, min: 197301, max: 250525 },
                        { rate: 0.35, min: 250526, max: 626350 },
                        { rate: 0.37, min: 626351, max: Infinity }
                    ],
                    'married': [
                        { rate: 0.10, min: 0, max: 23850 },
                        { rate: 0.12, min: 23851, max: 96950 },
                        { rate: 0.22, min: 96951, max: 206700 },
                        { rate: 0.24, min: 206701, max: 394600 },
                        { rate: 0.32, min: 394601, max: 501050 },
                        { rate: 0.35, min: 501051, max: 751600 },
                        { rate: 0.37, min: 751601, max: Infinity }
                    ]
                }
            };

            const FEDERAL_LTCG_BRACKETS = {
                '2024': {
                    'single': [
                        { rate: 0.00, min: 0, max: 47025 },
                        { rate: 0.15, min: 47026, max: 518900 },
                        { rate: 0.20, min: 518901, max: Infinity }
                    ],
                    'married': [
                        { rate: 0.00, min: 0, max: 94050 },
                        { rate: 0.15, min: 94051, max: 583750 },
                        { rate: 0.20, min: 583751, max: Infinity }
                    ]
                },
                '2025': {
                    'single': [
                        { rate: 0.00, min: 0, max: 48350 },
                        { rate: 0.15, min: 48351, max: 533400 },
                        { rate: 0.20, min: 533401, max: Infinity }
                    ],
                    'married': [
                        { rate: 0.00, min: 0, max: 96700 },
                        { rate: 0.15, min: 96701, max: 600050 },
                        { rate: 0.20, min: 600051, max: Infinity }
                    ]
                }
            };

            const STANDARD_DEDUCTIONS = {
                '2024': {
                    'single': 14600,
                    'married': 29200
                },
                '2025': {
                    'single': 15000,
                    'married': 30000
                }
            };

            const WA_CAPITAL_GAINS_RULES = {
                '2024': {
                    exemption: 270000,
                    tiers: [
                        { rate: 0.07, minThreshold: 270000, maxThreshold: Infinity }
                    ]
                },
                '2025': {
                    exemption: 278000,
                    tiers: [
                        { rate: 0.07, minThreshold: 278000, maxThreshold: 278000 + 1000000 },
                        { rate: 0.099, minThreshold: 278000 + 1000001, maxThreshold: Infinity }
                    ]
                }
            };

            const NIIT_THRESHOLDS = {
                'single': 200000,
                'married': 250000
            };

            // Helper function to calculate progressive tax and provide breakdown
            const calculateProgressiveTax = (income, brackets) => {
                let tax = 0;
                let remainingIncome = income;
                const breakdown = [];
                let marginalRate = 0;

                for (let i = 0; i < brackets.length; i++) {
                    const bracket = brackets[i];
                    const bracketLowerBound = bracket.min;
                    const bracketUpperBound = bracket.max;

                    const incomeInCurrentBracket = Math.min(remainingIncome, bracketUpperBound - bracketLowerBound + 1);

                    if (incomeInCurrentBracket > 0) {
                        const taxInCurrentBracket = incomeInCurrentBracket * bracket.rate;
                        tax += taxInCurrentBracket;
                        breakdown.push({
                            rate: bracket.rate,
                            min: bracket.min,
                            max: bracket.max,
                            incomeInBracket: incomeInCurrentBracket,
                            taxInBracket: taxInCurrentBracket
                        });
                        marginalRate = bracket.rate;
                        remainingIncome -= incomeInCurrentBracket;
                    }

                    if (remainingIncome <= 0) break;
                }
                return {
                    totalTax: tax,
                    breakdown: breakdown,
                    marginalRate: marginalRate,
                    taxableIncome: income
                };
            };

            const calculateFederalLTCGTax = (totalTaxableIncome, ltCGains, ltCGBrackets) => {
                let ltCGTax = 0;
                let remainingLTCG = ltCGains;
                const breakdown = [];
                let marginalRate = 0;
                let effectiveRate = 0;

                let ordinaryIncomeTaxableAmount = totalTaxableIncome - ltCGains;
                if (ordinaryIncomeTaxableAmount < 0) ordinaryIncomeTaxableAmount = 0;

                for (let i = 0; i < ltCGBrackets.length; i++) {
                    const bracket = ltCGBrackets[i];
                    const bracketStart = bracket.min;
                    const bracketEnd = bracket.max;

                    const actualLTCGBeginningForThisBracket = Math.max(ordinaryIncomeTaxableAmount, bracketStart);

                    if (actualLTCGBeginningForThisBracket >= totalTaxableIncome || remainingLTCG <= 0) {
                        break;
                    }

                    const incomePotentialInBracket = Math.min(
                        remainingLTCG,
                        Math.max(0, bracketEnd - actualLTCGBeginningForThisBracket + 1),
                        Math.max(0, totalTaxableIncome - actualLTCGBeginningForThisBracket)
                    );

                    if (incomePotentialInBracket > 0) {
                        const taxInCurrentBracket = incomePotentialInBracket * bracket.rate;
                        ltCGTax += taxInCurrentBracket;
                        breakdown.push({
                            rate: bracket.rate,
                            min: bracket.min,
                            max: bracket.max,
                            incomeInBracket: incomePotentialInBracket,
                            taxInBracket: taxInCurrentBracket
                        });
                        marginalRate = bracket.rate;
                        remainingLTCG -= incomePotentialInBracket;
                    }
                }

                if (ltCGains > 0) {
                    effectiveRate = ltCGTax / ltCGains;
                }

                return {
                    totalTax: ltCGTax,
                    breakdown: breakdown,
                    marginalRate: marginalRate,
                    effectiveRate: effectiveRate
                };
            };

            const calculateWACapitalGainsTax = (ltCGains, year) => {
                const rules = WA_CAPITAL_GAINS_RULES[year];
                if (!rules) return 0;

                let tax = 0;
                let taxableLTCG = Math.max(0, ltCGains - rules.exemption);

                if (taxableLTCG <= 0) return 0;

                for (let i = 0; i < rules.tiers.length; i++) {
                    const tier = rules.tiers[i];
                    const tierStartRelativeToExemption = Math.max(0, tier.minThreshold - rules.exemption);
                    const tierEndRelativeToExemption = tier.maxThreshold === Infinity ? Infinity : tier.maxThreshold - rules.exemption;

                    const incomeInThisTier = Math.min(taxableLTCG, tierEndRelativeToExemption) - tierStartRelativeToExemption;

                    if (incomeInThisTier > 0) {
                        tax += incomeInThisTier * tier.rate;
                    }
                    taxableLTCG -= incomeInThisTier;
                    if (taxableLTCG <= 0) break;
                }
                return tax;
            };

            const handleCalculate = (e) => {
                e.preventDefault();

                setErrorMessage('');
                setShowResults(false);

                const parsedOrdinaryIncome = rawOrdinaryIncome || 0;
                const parsedShortTermGains = rawShortTermGains || 0;
                const parsedLongTermGains = rawLongTermGains || 0;
                const parsedItemizedDeductions = rawItemizedDeductions || 0;

                if (parsedOrdinaryIncome < 0 || parsedShortTermGains < 0 || parsedLongTermGains < 0 || parsedItemizedDeductions < 0) {
                    setErrorMessage('Please enter non-negative values for all income and deduction fields.');
                    return;
                }

                const currentFederalIncomeBrackets = FEDERAL_INCOME_BRACKETS[taxYear][filingStatus];
                const currentFederalLTCGBrackets = FEDERAL_LTCG_BRACKETS[taxYear][filingStatus];
                const currentStandardDeduction = STANDARD_DEDUCTIONS[taxYear][filingStatus];
                const currentNIITThreshold = NIIT_THRESHOLDS[filingStatus];

                const adjustedGrossIncome = parsedOrdinaryIncome + parsedShortTermGains + parsedLongTermGains;
                const totalDeductions = Math.max(currentStandardDeduction, parsedItemizedDeductions);
                const taxableOrdinaryIncomeFederal = parsedOrdinaryIncome + parsedShortTermGains - totalDeductions;
                const taxableIncomeForFederalRates = Math.max(0, taxableOrdinaryIncomeFederal);

                const {
                    totalTax: calculatedFederalOrdinaryTax,
                    breakdown: ordinaryTaxBreakdown,
                    marginalRate: ordinaryMarginalRate,
                    taxableIncome: ordinaryTaxableIncomeUsed
                } = calculateProgressiveTax(taxableIncomeForFederalRates, currentFederalIncomeBrackets);

                setFederalOrdinaryTax(calculatedFederalOrdinaryTax);
                setFederalOrdinaryBreakdown(ordinaryTaxBreakdown);
                setFederalOrdinaryMarginalRate(ordinaryMarginalRate);

                const calculatedFederalOrdinaryEffectiveRate = ordinaryTaxableIncomeUsed > 0
                    ? calculatedFederalOrdinaryTax / ordinaryTaxableIncomeUsed
                    : 0;
                setFederalOrdinaryEffectiveRate(calculatedFederalOrdinaryEffectiveRate);

                const {
                    totalTax: calculatedFederalLTCGTax,
                    breakdown: ltcgTaxBreakdown,
                    marginalRate: ltcgMarginalRate,
                    effectiveRate: ltcgEffectiveRate
                } = calculateFederalLTCGTax(taxableIncomeForFederalRates + parsedLongTermGains, parsedLongTermGains, currentFederalLTCGBrackets);

                setFederalLTCGTax(calculatedFederalLTCGTax);
                setFederalLTCGBreakdown(ltcgTaxBreakdown);
                setFederalLTCGMarginalRate(ltcgMarginalRate);
                setFederalLTCGEffectiveRate(ltcgEffectiveRate);

                let calculatedNIIT = 0;
                if (adjustedGrossIncome > currentNIITThreshold) {
                    const netInvestmentIncome = parsedShortTermGains + parsedLongTermGains;
                    const agiOverThreshold = adjustedGrossIncome - currentNIITThreshold;
                    calculatedNIIT = Math.min(netInvestmentIncome, agiOverThreshold) * 0.038;
                }
                setNetInvestmentIncomeTax(calculatedNIIT);

                const calculatedWaCapitalGainsTax = calculateWACapitalGainsTax(parsedLongTermGains, taxYear);
                setWaCapitalGainsTax(calculatedWaCapitalGainsTax);

                const totalCalculatedTax = calculatedFederalOrdinaryTax + calculatedFederalLTCGTax + calculatedNIIT + calculatedWaCapitalGainsTax;
                setTotalTax(totalCalculatedTax);

                setShowResults(true);
            };

            // --- LLM Integration Functions ---
            const callGeminiAPI = async (prompt) => {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = ""
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-04-17:generateContent?key=${apiKey}`;

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        console.error('Gemini API returned an unexpected structure:', result);
                        return 'Could not retrieve information. Please try again.';
                    }
                } catch (error) {
                    console.error('Error calling Gemini API:', error);
                    return 'Error fetching data from the API.';
                }
            };

            const handleGetTaxTips = async () => {
                setIsLoadingTips(true);
                setTaxTips('');

                const prompt = `Based on the following (simplified) tax information for tax year ${taxYear}, filing status ${filingStatus}, total taxable income (before capital gains) of $${rawOrdinaryIncome}, short-term capital gains of $${rawShortTermGains}, and long-term capital gains of $${rawLongTermGains}, suggest 3-5 general tax-saving tips related to investments or income. Focus on broad, common strategies that might be relevant. Do not include specific numbers or tax advice, just general tips.`;
                const tips = await callGeminiAPI(prompt);
                setTaxTips(tips);
                setIsLoadingTips(false);
            };

            const handleExplainCapitalGains = async () => {
                setIsLoadingExplanation(true);
                setCapitalGainsExplanation('');

                const prompt = "Please provide a simple, concise explanation of what long-term and short-term capital gains are in the context of US federal taxes. Include the main difference (holding period) and how they are generally taxed.";
                const explanation = await callGeminiAPI(prompt);
                setCapitalGainsExplanation(explanation);
                setIsLoadingExplanation(false);
            };


            return (
                <div className="p-8 rounded-xl w-full">
                    <h1 className="text-3xl font-bold text-center text-gray-800 mb-6">Capital Gains Tax Calculator</h1>

                    {errorMessage && (
                        <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md mb-4" role="alert">
                            {errorMessage}
                        </div>
                    )}

                    <form onSubmit={handleCalculate} className="space-y-4">
                        {/* Tax Year Selection */}
                        <div>
                            <label htmlFor="taxYear" className="block text-sm font-medium text-gray-700 mb-1">Select Tax Year:</label>
                            <select
                                id="taxYear"
                                value={taxYear}
                                onChange={(e) => setTaxYear(e.target.value)}
                                className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm"
                            >
                                <option value="2024">2024</option>
                                <option value="2025">2025</option>
                            </select>
                        </div>

                        {/* Filing Status Selection */}
                        <div>
                            <span className="block text-sm font-medium text-gray-700 mb-1">Filing Status:</span>
                            <div className="mt-1 flex space-x-4">
                                <label className="inline-flex items-center">
                                    <input
                                        type="radio"
                                        className="form-radio text-indigo-600"
                                        name="filingStatus"
                                        value="single"
                                        checked={filingStatus === 'single'}
                                        onChange={(e) => setFilingStatus(e.target.value)}
                                    />
                                    <span className="ml-2 text-gray-700">Single</span>
                                </label>
                                <label className="inline-flex items-center">
                                    <input
                                        type="radio"
                                        className="form-radio text-indigo-600"
                                        name="filingStatus"
                                        value="married"
                                        checked={filingStatus === 'married'}
                                        onChange={(e) => setFilingStatus(e.target.value)}
                                    />
                                    <span className="ml-2 text-gray-700">Married Filing Jointly</span>
                                </label>
                            </div>
                        </div>

                        {/* Income and Gains Inputs */}
                        <div>
                            <label htmlFor="ordinaryIncome" className="block text-sm font-medium text-gray-700 mb-1">Total Taxable Income (before capital gains):</label>
                            <input
                                type="text"
                                id="ordinaryIncome"
                                value={ordinaryIncome}
                                onChange={(e) => handleInputChangeFormatted(e, setRawOrdinaryIncome, setOrdinaryIncome)}
                                onBlur={() => handleInputBlurFormatted(setOrdinaryIncome, rawOrdinaryIncome)}
                                onFocus={() => handleInputFocusFormatted(setOrdinaryIncome, rawOrdinaryIncome)}
                                className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                placeholder="e.g., $75,000"
                            />
                        </div>

                        <div>
                            <label htmlFor="shortTermGains" className="block text-sm font-medium text-gray-700 mb-1">Short-Term Capital Gains (assets held ≤ 1 year):</label>
                            <input
                                type="text"
                                id="shortTermGains"
                                value={shortTermGains}
                                onChange={(e) => handleInputChangeFormatted(e, setRawShortTermGains, setShortTermGains)}
                                onBlur={() => handleInputBlurFormatted(setShortTermGains, rawShortTermGains)}
                                onFocus={() => handleInputFocusFormatted(setShortTermGains, rawShortTermGains)}
                                className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                placeholder="e.g., $5,000"
                            />
                        </div>

                        <div>
                            <label htmlFor="longTermGains" className="block text-sm font-medium text-gray-700 mb-1">Long-Term Capital Gains (assets held > 1 year):</label>
                            <input
                                type="text"
                                id="longTermGains"
                                value={longTermGains}
                                onChange={(e) => handleInputChangeFormatted(e, setRawLongTermGains, setLongTermGains)}
                                onBlur={() => handleInputBlurFormatted(setLongTermGains, rawLongTermGains)}
                                onFocus={() => handleInputFocusFormatted(setLongTermGains, rawLongTermGains)}
                                className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                placeholder="e.g., $10,000"
                            />
                        </div>

                        <div>
                            <label htmlFor="itemizedDeductions" className="block text-sm font-medium text-gray-700 mb-1">Total Itemized Deductions (optional, enter if greater than standard deduction):</label>
                            <input
                                type="text"
                                id="itemizedDeductions"
                                value={itemizedDeductions}
                                onChange={(e) => handleInputChangeFormatted(e, setRawItemizedDeductions, setItemizedDeductions)}
                                onBlur={() => handleInputBlurFormatted(setItemizedDeductions, rawItemizedDeductions)}
                                onFocus={() => handleInputFocusFormatted(setItemizedDeductions, rawItemizedDeductions)}
                                className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                placeholder="e.g., $20,000"
                            />
                            <p className="mt-1 text-xs text-gray-500">
                                Standard deduction for {taxYear} ({filingStatus === 'single' ? 'Single' : 'Married Filing Jointly'}): {formatCurrencyWithCents(STANDARD_DEDUCTIONS[taxYear][filingStatus])}.
                                The calculator will automatically use the higher of standard or your itemized deductions.
                            </p>
                        </div>

                        {/* Calculate Button */}
                        <button
                            type="submit"
                            className="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition ease-in-out duration-150 shadow-md"
                        >
                            Calculate Tax
                        </button>
                    </form>

                    {/* LLM Feature Buttons */}
                    <div className="mt-6 flex flex-col space-y-2">
                        <button
                            onClick={handleGetTaxTips}
                            className="w-full bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition ease-in-out duration-150 shadow-md"
                            disabled={isLoadingTips}
                        >
                            {isLoadingTips ? 'Generating Tips...' : '✨ Get Tax Tips'}
                        </button>
                        <button
                            onClick={handleExplainCapitalGains}
                            className="w-full bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition ease-in-out duration-150 shadow-md"
                            disabled={isLoadingExplanation}
                        >
                            {isLoadingExplanation ? 'Getting Explanation...' : '✨ Explain Capital Gains'}
                        </button>
                    </div>

                    {/* LLM Results Display */}
                    {(taxTips || capitalGainsExplanation) && (
                        <div className="mt-8 pt-6 border-t-2 border-gray-200">
                            <h2 className="text-2xl font-bold text-center text-gray-800 mb-4">AI Insights</h2>
                            {isLoadingTips && <p className="text-center text-gray-600">Generating tax tips...</p>}
                            {taxTips && (
                                <div className="bg-blue-50 border border-blue-200 text-blue-800 p-4 rounded-md mb-4">
                                    <h3 className="font-semibold text-lg mb-2">Tax Tips for You:</h3>
                                    <p className="whitespace-pre-wrap">{taxTips}</p>
                                </div>
                            )}

                            {isLoadingExplanation && <p className="text-center text-gray-600">Getting capital gains explanation...</p>}
                            {capitalGainsExplanation && (
                                <div className="bg-blue-50 border border-blue-200 text-blue-800 p-4 rounded-md">
                                    <h3 className="font-semibold text-lg mb-2">Understanding Capital Gains:</h3>
                                    <p className="whitespace-pre-wrap">{capitalGainsExplanation}</p>
                                </div>
                            )}
                        </div>
                    )}


                    {/* Results Display */}
                    {showResults && (
                        <div className="mt-8 pt-6 border-t-2 border-gray-200">
                            <h2 className="text-2xl font-bold text-center text-gray-800 mb-4">Tax Calculation Results</h2>
                            <div className="space-y-2 text-gray-700">
                                <div className="flex justify-between items-center bg-gray-50 p-3 rounded-md">
                                    <span className="font-medium">Federal Ordinary Income & Short-Term Capital Gains Tax:</span>
                                    <span className="font-semibold text-lg text-green-700">{formatCurrencyWithCents(federalOrdinaryTax)}</span>
                                </div>
                                <div className="flex justify-between items-center bg-gray-50 p-3 rounded-md">
                                    <span className="font-medium">Federal Long-Term Capital Gains Tax:</span>
                                    <span className="font-semibold text-lg text-green-700">{formatCurrencyWithCents(federalLTCGTax)}</span>
                                </div>
                                <div className="flex justify-between items-center bg-gray-50 p-3 rounded-md">
                                    <span className="font-medium">Federal Net Investment Income Tax (NIIT):</span>
                                    <span className="font-semibold text-lg text-green-700">{formatCurrencyWithCents(netInvestmentIncomeTax)}</span>
                                </div>
                                <div className="flex justify-between items-center bg-gray-50 p-3 rounded-md">
                                    <span className="font-medium">Washington State Capital Gains Tax:</span>
                                    <span className="font-semibold text-lg text-green-700">{formatCurrencyWithCents(waCapitalGainsTax)}</span>
                                </div>

                                {/* Federal Ordinary Tax Breakdown Table */}
                                {federalOrdinaryBreakdown.length > 0 && (
                                    <div className="bg-gray-50 p-3 rounded-md mt-4">
                                        <h3 className="text-md font-semibold text-gray-800 mb-2">Federal Ordinary Income Tax Breakdown:</h3>
                                        <table className="min-w-full divide-y divide-gray-200">
                                            <thead className="bg-gray-100">
                                                <tr>
                                                    <th scope="col" className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-md">Tax Rate</th>
                                                    <th scope="col" className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tax Range</th>
                                                    <th scope="col" className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Income in Bracket</th>
                                                    <th scope="col" className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-md">Tax in Bracket</th>
                                                </tr>
                                            </thead>
                                            <tbody className="bg-white divide-y divide-gray-200">
                                                {federalOrdinaryBreakdown.map((item, index) => (
                                                    <tr key={index}>
                                                        <td className="px-3 py-2 whitespace-nowrap text-sm text-gray-900">{formatPercentage(item.rate)}</td>
                                                        <td className="px-3 py-2 whitespace-nowrap text-sm text-gray-900">
                                                            {formatCurrencyWithCents(item.min)} - {item.max === Infinity ? 'And up' : formatCurrencyWithCents(item.max)}
                                                        </td>
                                                        <td className="px-3 py-2 whitespace-nowrap text-sm text-gray-900">{formatCurrencyWithCents(item.incomeInBracket)}</td>
                                                        <td className="px-3 py-2 whitespace-nowrap text-sm text-gray-900">{formatCurrencyWithCents(item.taxInBracket)}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                        <div className="mt-2 text-sm text-gray-700 flex justify-between items-center">
                                            <span className="font-medium">Marginal Tax Rate:</span>
                                            <span className="font-semibold">{formatPercentage(federalOrdinaryMarginalRate)}</span>
                                        </div>
                                        <div className="mt-1 text-sm text-gray-700 flex justify-between items-center">
                                            <span className="font-medium">Effective Tax Rate (on taxable ordinary income):</span>
                                            <span className="font-semibold">{formatPercentage(federalOrdinaryEffectiveRate)}</span>
                                        </div>
                                    </div>
                                )}

                                {/* Federal Long-Term Capital Gains Tax Breakdown Table */}
                                {federalLTCGBreakdown.length > 0 && (
                                    <div className="bg-gray-50 p-3 rounded-md mt-4">
                                        <h3 className="text-md font-semibold text-gray-800 mb-2">Federal Long-Term Capital Gains Tax Breakdown:</h3>
                                        <table className="min-w-full divide-y divide-gray-200">
                                            <thead className="bg-gray-100">
                                                <tr>
                                                    <th scope="col" className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-md">Tax Rate</th>
                                                    <th scope="col" className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tax Range</th>
                                                    <th scope="col" className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Income in Bracket</th>
                                                    <th scope="col" className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-md">Tax in Bracket</th>
                                                </tr>
                                            </thead>
                                            <tbody className="bg-white divide-y divide-gray-200">
                                                {federalLTCGBreakdown.map((item, index) => (
                                                    <tr key={index}>
                                                        <td className="px-3 py-2 whitespace-nowrap text-sm text-gray-900">{formatPercentage(item.rate)}</td>
                                                        <td className="px-3 py-2 whitespace-nowrap text-sm text-gray-900">
                                                            {formatCurrencyWithCents(item.min)} - {item.max === Infinity ? 'And up' : formatCurrencyWithCents(item.max)}
                                                        </td>
                                                        <td className="px-3 py-2 whitespace-nowrap text-sm text-gray-900">{formatCurrencyWithCents(item.incomeInBracket)}</td>
                                                        <td className="px-3 py-2 whitespace-nowrap text-sm text-gray-900">{formatCurrencyWithCents(item.taxInBracket)}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                        <div className="mt-2 text-sm text-gray-700 flex justify-between items-center">
                                            <span className="font-medium">Marginal Tax Rate (LTCG):</span>
                                            <span className="font-semibold">{formatPercentage(federalLTCGMarginalRate)}</span>
                                        </div>
                                        <div className="mt-1 text-sm text-gray-700 flex justify-between items-center">
                                            <span className="font-medium">Effective Tax Rate (on LTCG):</span>
                                            <span className="font-semibold">{formatPercentage(federalLTCGEffectiveRate)}</span>
                                        </div>
                                    </div>
                                )}

                                <div className="flex justify-between items-center bg-indigo-100 p-4 rounded-md mt-4 border-t border-indigo-200">
                                    <span className="text-xl font-bold text-indigo-800">Total Estimated Tax Owed:</span>
                                    <span className="text-xl font-bold text-indigo-800">{formatCurrencyWithCents(totalTax)}</span>
                                </div>
                                <p className="text-sm text-gray-500 mt-4 italic">
                                    Disclaimer: This calculator provides estimates based on publicly available tax information for the specified years. It is not financial or tax advice. For accurate tax planning, please consult with a qualified tax professional. Tax laws are complex and subject to change.
                                </p>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- Asset Allocation Calculator Component ---
        const AssetAllocationCalculator = () => {
            const [totalAmount, setTotalAmount] = React.useState('');
            const [rawTotalAmount, setRawTotalAmount] = React.useState(0);
            const [domesticStocksPct, setDomesticStocksPct] = React.useState('50');
            const [internationalStocksPct, setInternationalStocksPct] = React.useState('20');
            const [bondsPct, setBondsPct] = React.useState('20');
            const [cashPct, setCashPct] = React.useState('10');
            const [mainAllocationError, setMainAllocationError] = React.useState('');

            // ETF distribution states
            const [domesticETFPcts, setDomesticETFPcts] = React.useState([40, 20, 20, 10, 10].map(String)); // Store as strings
            const [internationalETFPcts, setInternationalETFPcts] = React.useState([40, 20, 20, 10, 10].map(String)); // Store as strings
            const [bondsETFPcts, setBondsETFPcts] = React.useState([40, 20, 20, 10, 10].map(String)); // Store as strings

            // ETF error states
            const [domesticETFError, setDomesticETFError] = React.useState('');
            const [internationalETFError, setInternationalETFError] = React.useState('');
            const [bondsETFError, setBondsETFError] = React.useState('');

            const chartRef = React.useRef(null);

            // Helper to validate ETF percentage sums
            const validateETFPctSum = (etfPcts) => {
                const sum = etfPcts.reduce((acc, pct) => acc + (parseFloat(pct) || 0), 0);
                return Math.abs(sum - 100) < 0.01; // Allow for tiny floating point inaccuracies
            };

            // Calculate dollar values based on percentages
            const calculatedAllocations = React.useMemo(() => {
                const dom = (rawTotalAmount * (parseFloat(domesticStocksPct) || 0)) / 100;
                const inter = (rawTotalAmount * (parseFloat(internationalStocksPct) || 0)) / 100;
                const bonds = (rawTotalAmount * (parseFloat(bondsPct) || 0)) / 100;
                const cash = (rawTotalAmount * (parseFloat(cashPct) || 0)) / 100;
                return { dom, inter, bonds, cash };
            }, [rawTotalAmount, domesticStocksPct, internationalStocksPct, bondsPct, cashPct]);

            // Calculate ETF breakdown dollar values
            const calculateETFBreakdown = (categoryAmount, etfPcts) => {
                return etfPcts.map((pct, index) => ({
                    name: `ETF-${index + 1}`,
                    percentage: parseFloat(pct) || 0,
                    amount: (categoryAmount * (parseFloat(pct) || 0)) / 100
                }));
            };

            const domesticETFs = React.useMemo(() => calculateETFBreakdown(calculatedAllocations.dom, domesticETFPcts), [calculatedAllocations.dom, domesticETFPcts]);
            const internationalETFs = React.useMemo(() => calculateETFBreakdown(calculatedAllocations.inter, internationalETFPcts), [calculatedAllocations.inter, internationalETFPcts]);
            const bondsETFs = React.useMemo(() => calculateETFBreakdown(calculatedAllocations.bonds, bondsETFPcts), [calculatedAllocations.bonds, bondsETFPcts]);


            // Validate main allocation percentages
            React.useEffect(() => {
                const total = (parseFloat(domesticStocksPct) || 0) +
                              (parseFloat(internationalStocksPct) || 0) +
                              (parseFloat(bondsPct) || 0) +
                              (parseFloat(cashPct) || 0);
                if (total !== 100 && total > 0) {
                    setMainAllocationError(`Main percentages must sum to 100%. Current sum: ${total}%`);
                } else {
                    setMainAllocationError('');
                }
            }, [domesticStocksPct, internationalStocksPct, bondsPct, cashPct]);

            // Validate ETF percentages
            React.useEffect(() => {
                if (!validateETFPctSum(domesticETFPcts)) {
                    setDomesticETFError("Domestic Stocks ETFs must sum to 100%.");
                } else {
                    setDomesticETFError('');
                }
                if (!validateETFPctSum(internationalETFPcts)) {
                    setInternationalETFError("International Stocks ETFs must sum to 100%.");
                } else {
                    setInternationalETFError('');
                }
                if (!validateETFPctSum(bondsETFPcts)) {
                    setBondsETFError("Bonds ETFs must sum to 100%.");
                } else {
                    setBondsETFError('');
                }
            }, [domesticETFPcts, internationalETFPcts, bondsETFPcts]);


            // Draw pie chart
            React.useEffect(() => {
                const data = [
                    { name: 'Domestic Stocks', pct: parseFloat(domesticStocksPct) || 0, amount: calculatedAllocations.dom, color: '#4F46E5' }, // indigo-600
                    { name: 'International Stocks', pct: parseFloat(internationalStocksPct) || 0, amount: calculatedAllocations.inter, color: '#A855F7' }, // purple-500
                    { name: 'Bonds', pct: parseFloat(bondsPct) || 0, amount: calculatedAllocations.bonds, color: '#EC4899' }, // pink-500
                    { name: 'Cash', pct: parseFloat(cashPct) || 0, amount: calculatedAllocations.cash, color: '#10B981' } // emerald-500
                ].filter(d => d.pct > 0); // Only show slices with values > 0

                const width = 300;
                const height = 300;
                const radius = Math.min(width, height) / 2;

                d3.select(chartRef.current).selectAll("*").remove(); // Clear previous chart

                const svg = d3.select(chartRef.current)
                    .attr("width", width)
                    .attr("height", height + 120) // Increased height to accommodate the legend and two lines of text, more room for legend
                    .append("g")
                    .attr("transform", `translate(${width / 2}, ${height / 2})`); // Center the pie itself

                const pie = d3.pie()
                    .sort(null)
                    .value(d => d.pct);

                const arc = d3.arc()
                    .innerRadius(0)
                    .outerRadius(radius);

                const arcs = svg.selectAll(".arc")
                    .data(pie(data))
                    .enter()
                    .append("g")
                    .attr("class", "arc");

                arcs.append("path")
                    .attr("d", arc)
                    .attr("fill", d => d.data.color)
                    .attr("stroke", "white")
                    .style("stroke-width", "1px");

                // Add text labels for percentage
                arcs.append("text")
                    .attr("transform", d => `translate(${arc.centroid(d)})`)
                    .attr("dy", "-0.15em") // Position slightly above center for percentage
                    .attr("font-size", "12px")
                    .attr("font-weight", "600")
                    .attr("fill", "white")
                    .style("text-anchor", "middle")
                    .text(d => d.data.pct > 5 ? `${Math.round(d.data.pct)}%` : '');

                // Add text labels for dollar value
                arcs.append("text")
                    .attr("transform", d => `translate(${arc.centroid(d)})`)
                    .attr("dy", "1.0em") // Position below percentage for dollar value
                    .attr("font-size", "11px") // Slightly smaller font for dollar value
                    .attr("fill", "white")
                    .style("text-anchor", "middle")
                    .text(d => d.data.pct > 5 ? formatCurrencyInteger(d.data.amount) : '');


                // --- Legend positioning ---
                // Calculate position for the entire legend group
                const legendContainerY = radius + 60; // Y position for the entire legend container (more space below the pie)

                const legend = svg.append("g")
                    .attr("class", "legend")
                    .attr("transform", `translate(0, ${legendContainerY})`); // Initial position for the legend container

                let currentXPos = 0; // Tracks the horizontal position for each legend item

                const legendItems = legend.selectAll(".legend-item")
                    .data(data)
                    .enter()
                    .append("g")
                    .attr("class", "legend-item")
                    .attr("transform", (d, i) => {
                        const itemX = currentXPos;
                        // Estimate width for each item (color box + text + padding)
                        // This is an approximation. A more precise way would involve measuring text.
                        const textWidthEstimate = d.name.length * 6; // Rough estimate per char
                        const itemTotalWidth = 12 + 5 + textWidthEstimate + 20; // Box + padding + text + spacing for next item
                        currentXPos += itemTotalWidth; // Increment for the next item
                        return `translate(${itemX}, 0)`;
                    });

                legendItems.append("rect")
                    .attr("width", 12)
                    .attr("height", 12)
                    .attr("fill", d => d.color)
                    .attr("ry", 3); // Rounded corners for legend color box

                legendItems.append("text")
                    .attr("x", 18) // Position text relative to its rect
                    .attr("y", 9)  // Vertical alignment
                    .attr("font-size", "12px")
                    .attr("fill", "#333")
                    .text(d => d.name);

                // Center the entire legend group after all items are added and currentXPos is final
                legend.attr("transform", `translate(${-currentXPos / 2}, ${legendContainerY})`);

            }, [domesticStocksPct, internationalStocksPct, bondsPct, cashPct, rawTotalAmount]); // Redraw chart when percentages or total amount change

            const ETFDeductionTable = ({ title, etfBreakdown, etfPcts, setETFPcts, error }) => {
                // Internal state to hold the current raw input values for each ETF percentage
                // This state is local to this component and does not trigger parent re-renders on change
                const [localEtfInputPcts, setLocalEtfInputPcts] = React.useState(etfPcts);

                // Update local state when parent etfPcts change (e.g., when the component is first mounted or parent resets)
                // This ensures consistency if parent state updates for other reasons
                React.useEffect(() => {
                    setLocalEtfInputPcts(etfPcts);
                }, [etfPcts]);

                const handleLocalETFPercentageChange = (index, value) => {
                    const newLocalPcts = [...localEtfInputPcts];
                    newLocalPcts[index] = value; // Keep as string for smooth typing
                    setLocalEtfInputPcts(newLocalPcts);
                };

                const handleLocalETFPercentageBlur = (index, value) => {
                    // When the input loses focus, update the parent state with the parsed value
                    // This will trigger the main validation and re-render the chart/tables
                    const parsedValue = parseFloat(value) || 0;
                    const newPcts = [...etfPcts]; // Get the latest parent state
                    newPcts[index] = String(parsedValue); // Ensure it's a string for consistency
                    setETFPcts(newPcts); // Update parent state
                };

                return (
                    <div className="bg-gray-50 p-4 rounded-md shadow-sm">
                        <h4 className="text-lg font-semibold text-gray-800 mb-3">{title} ETF Distribution:</h4>
                        {error && (
                            <div className="bg-red-100 border border-red-400 text-red-700 px-3 py-2 rounded-md text-sm mb-3">
                                {error}
                            </div>
                        )}
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-100">
                                <tr>
                                    <th scope="col" className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-md">ETF Name</th>
                                    <th scope="col" className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Percentage (%)</th>
                                    <th scope="col" className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-md">Allocated Amount</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {etfBreakdown.map((etf, index) => (
                                    <tr key={index}>
                                        <td className="px-3 py-2 whitespace-nowrap text-sm text-gray-900">{etf.name}</td>
                                        <td className="px-3 py-2 whitespace-nowrap text-sm text-gray-900">
                                            <input
                                                type="number"
                                                value={localEtfInputPcts[index]} // Controlled by local state
                                                onChange={(e) => handleLocalETFPercentageChange(index, e.target.value)}
                                                onBlur={(e) => handleLocalETFPercentageBlur(index, e.target.value)}
                                                className="w-20 px-2 py-1 border border-gray-300 rounded-md shadow-sm text-sm"
                                                min="0" max="100"
                                            /> %
                                        </td>
                                        <td className="px-3 py-2 whitespace-nowrap text-sm text-gray-900">{formatCurrencyInteger(etf.amount)}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        <p className="mt-3 text-sm text-gray-600">
                            Total: {etfPcts.reduce((acc, pct) => acc + (parseFloat(pct) || 0), 0)}%
                        </p>
                    </div>
                );
            };

            return (
                <div className="p-8 rounded-xl w-full">
                    <h1 className="text-3xl font-bold text-center text-gray-800 mb-6">Asset Allocation Calculator</h1>

                    <div className="space-y-4">
                        <div>
                            <label htmlFor="totalAmount" className="block text-sm font-medium text-gray-700 mb-1">Total Amount to Allocate:</label>
                            <input
                                type="text"
                                id="totalAmount"
                                value={totalAmount}
                                onChange={(e) => handleInputChangeFormatted(e, setRawTotalAmount, setTotalAmount)}
                                onBlur={() => handleInputBlurFormatted(setTotalAmount, rawTotalAmount)}
                                onFocus={() => handleInputFocusFormatted(setTotalAmount, rawTotalAmount)}
                                className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                placeholder="e.g., $100,000"
                            />
                        </div>

                        {/* Allocation Percentages */}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label htmlFor="domesticStocksPct" className="block text-sm font-medium text-gray-700 mb-1">Domestic Stocks (%):</label>
                                <input
                                    type="number"
                                    id="domesticStocksPct"
                                    value={domesticStocksPct}
                                    onChange={(e) => setDomesticStocksPct(e.target.value)}
                                    className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                    min="0" max="100"
                                />
                            </div>
                            <div>
                                <label htmlFor="internationalStocksPct" className="block text-sm font-medium text-gray-700 mb-1">International Stocks (%):</label>
                                <input
                                    type="number"
                                    id="internationalStocksPct"
                                    value={internationalStocksPct}
                                    onChange={(e) => setInternationalStocksPct(e.target.value)}
                                    className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                    min="0" max="100"
                                />
                            </div>
                            <div>
                                <label htmlFor="bondsPct" className="block text-sm font-medium text-gray-700 mb-1">Bonds (%):</label>
                                <input
                                    type="number"
                                    id="bondsPct"
                                    value={bondsPct}
                                    onChange={(e) => setBondsPct(e.target.value)}
                                    className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                    min="0" max="100"
                                />
                            </div>
                            <div>
                                <label htmlFor="cashPct" className="block text-sm font-medium text-gray-700 mb-1">Cash (%):</label>
                                <input
                                    type="number"
                                    id="cashPct"
                                    value={cashPct}
                                    onChange={(e) => setCashPct(e.target.value)}
                                    className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                    min="0" max="100"
                                />
                            </div>
                        </div>

                        {mainAllocationError && (
                            <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md mt-4" role="alert">
                                {mainAllocationError}
                            </div>
                        )}

                        {/* Calculated Dollar Values */}
                        <div className="mt-6 pt-4 border-t border-gray-200">
                            <h3 className="text-xl font-bold text-gray-800 mb-4">Allocated Amounts:</h3>
                            <div className="space-y-2 text-gray-700">
                                <div className="flex justify-between items-center bg-gray-50 p-2 rounded-md">
                                    <span className="font-medium">Domestic Stocks:</span>
                                    <span className="font-semibold text-green-700">{formatCurrencyInteger(calculatedAllocations.dom)}</span>
                                </div>
                                <div className="flex justify-between items-center bg-gray-50 p-2 rounded-md">
                                    <span className="font-medium">International Stocks:</span>
                                    <span className="font-semibold text-green-700">{formatCurrencyInteger(calculatedAllocations.inter)}</span>
                                </div>
                                <div className="flex justify-between items-center bg-gray-50 p-2 rounded-md">
                                    <span className="font-medium">Bonds:</span>
                                    <span className="font-semibold text-green-700">{formatCurrencyInteger(calculatedAllocations.bonds)}</span>
                                </div>
                                <div className="flex justify-between items-center bg-gray-50 p-2 rounded-md">
                                    <span className="font-medium">Cash:</span>
                                    <span className="font-semibold text-green-700">{formatCurrencyInteger(calculatedAllocations.cash)}</span>
                                </div>
                            </div>
                        </div>

                        {/* Pie Chart and ETF Breakdown Tables - Layout: Pie on top, tables below horizontally */}
                        <div className="mt-8 flex flex-col items-center gap-6 w-full"> {/* Changed to flex-col and added items-center for centering */}
                            {/* Pie Chart */}
                            <div className="flex-shrink-0 mb-8"> {/* mb-8 for spacing below chart */}
                                <svg ref={chartRef}></svg>
                            </div>

                            {/* ETF Breakdown Tables Container - Optimized for horizontal layout */}
                            <div className="flex flex-wrap justify-center items-start gap-4 w-full xl:gap-6"> {/* Reduced gap on smaller screens, larger gap on xl+ */}
                                    <ETFDeductionTable
                                        title="Domestic Stocks"
                                        etfBreakdown={domesticETFs}
                                        etfPcts={domesticETFPcts}
                                        setETFPcts={setDomesticETFPcts}
                                        error={domesticETFError}
                                    />
                                    <ETFDeductionTable
                                        title="International Stocks"
                                        etfBreakdown={internationalETFs}
                                        etfPcts={internationalETFPcts}
                                        setETFPcts={setInternationalETFPcts}
                                        error={internationalETFError}
                                    />
                                    <ETFDeductionTable
                                        title="Bonds"
                                        etfBreakdown={bondsETFs}
                                        etfPcts={bondsETFPcts}
                                        setETFPcts={setBondsETFPcts}
                                        error={bondsETFError}
                                    />
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main App Component to switch between calculators ---
        const App = () => {
            const [currentView, setCurrentView] = React.useState('tax'); // 'tax' or 'assetAllocation'

            return (
                <div className={`bg-white rounded-xl shadow-lg w-full mx-auto ${currentView === 'assetAllocation' ? 'max-w-7xl' : 'max-w-4xl'}`}> {/* Enlarged frame for Asset Allocation */}
                    <div className="flex justify-center p-4 bg-gray-100 border-b border-gray-200 rounded-t-xl">
                        <button
                            onClick={() => setCurrentView('tax')}
                            className={`px-6 py-2 rounded-l-lg font-medium text-sm transition ease-in-out duration-150 ${
                                currentView === 'tax' ? 'bg-indigo-600 text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                            }`}
                        >
                            Tax Calculator
                        </button>
                        <button
                            onClick={() => setCurrentView('assetAllocation')}
                            className={`px-6 py-2 rounded-r-lg font-medium text-sm transition ease-in-out duration-150 ${
                                currentView === 'assetAllocation' ? 'bg-indigo-600 text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                            }`}
                        >
                            Asset Allocation
                        </button>
                    </div>

                    <div className="p-4">
                        {currentView === 'tax' ? <CapitalGainsTaxCalculator /> : <AssetAllocationCalculator />}
                    </div>
                </div>
            );
        };

        // Render the App component into the root div
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
